name: Download Build Dependencies

permissions:
  contents: read
  actions: write

on:
  workflow_call:

jobs:
  download-dependencies:
    name: Download Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      actions: write
    steps:
    - name: Download Wild KSU
      shell: bash
      run: |
        # Download and run KSU setup
        git clone "https://github.com/WildKernels/Wild_KSU.git" -b "canary" --depth=1

        git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0 --depth=1
        echo "AnyKernel3 commit: $(cd AnyKernel3 && git rev-parse --short HEAD)"
        
        git clone https://github.com/WildKernels/kernel_patches.git --depth=1
        echo "Kernel Patches commit: $(cd kernel_patches && git rev-parse --short HEAD)"
        
        mkdir -p susfs_cache

        # List of all SUSFS branches we support
        BRANCHES=(
          "gki-android12-5.10"
          "gki-android13-5.10"
          "gki-android13-5.15"
          "gki-android14-5.15"
          "gki-android14-6.1"
          "gki-android15-6.6"
          "gki-android16-6.12"
        )

        for BRANCH in "${BRANCHES[@]}"; do
          # Clone SUSFS branch
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$BRANCH" --depth=1 "susfs_cache/$BRANCH" || {
            echo "Warning: Failed to clone branch $BRANCH (may not exist yet)"
            continue
          }
          COMMIT=$(cd "susfs_cache/$BRANCH" && git rev-parse --short HEAD 2>/dev/null || echo "N/A")
          echo "  └─ Commit: $COMMIT"
        done

        BRANCH_COUNT=$(ls -d susfs_cache/* 2>/dev/null | wc -l)
        echo "SUSFS branches downloaded: $BRANCH_COUNT"

        mkdir -p git-repo
        curl -L https://storage.googleapis.com/git-repo-downloads/repo -o git-repo/repo
        chmod 0755 git-repo/repo

    - name: Upload Build Dependencies
      uses: actions/upload-artifact@v4
      with:
        name: build-dependencies
        path: |
          AnyKernel3/
          kernel_patches/
          susfs_cache/
          git-repo/
          Wild_KSU/
          Baseband-guard/
        compression-level: 9
